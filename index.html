import React, { useState, useEffect } from 'react';
import { Plus, Calendar, Bell, Heart, Lightbulb, Trash2, XCircle } from 'lucide-react'; // Importujemy ikony

// Główny komponent aplikacji
const App = () => {
  // Stan dla przypomnień
  const [reminders, setReminders] = useState([]);
  // Stan dla wydarzeń (spotkań/randek)
  const [events, setEvents] = useState([]);
  // Stan dla tekstu nowego przypomnienia
  const [newReminderText, setNewReminderText] = useState('');
  // Stan dla daty nowego przypomnienia
  const [newReminderDate, setNewReminderDate] = useState('');
  // Stan dla czasu nowego przypomnienia
  const [newReminderTime, setNewReminderTime] = useState('');
  // Stan dla tytułu nowego wydarzenia
  const [newEventTitle, setNewEventTitle] = useState('');
  // Stan dla daty nowego wydarzenia
  const [newEventDate, setNewEventDate] = useState('');
  // Stan dla czasu nowego wydarzenia
  const [newEventTime, setNewEventTime] = useState('');
  // Stan dla miejsca nowego wydarzenia
  const [newEventLocation, setNewEventLocation] = useState('');
  // Stan, czy wydarzenie jest randką
  const [isDateEvent, setIsDateEvent] = useState(false);
  // Stan dla pomysłów na randki
  const [dateIdeas, setDateIdeas] = useState([]);
  // Stan ładowania pomysłów na randki
  const [loadingDateIdeas, setLoadingDateIdeas] = useState(false);
  // Stan dla widoczności modalu (do alertów/potwierdzeń)
  const [showModal, setShowModal] = useState(false);
  // Stan dla wiadomości w modalu
  const [modalMessage, setModalMessage] = useState('');

  // Funkcja do wyświetlania modalu
  const showCustomModal = (message) => {
    setModalMessage(message);
    setShowModal(true);
  };

  // Funkcja do dodawania nowego przypomnienia
  const addReminder = () => {
    if (newReminderText.trim() === '' || newReminderDate === '' || newReminderTime === '') {
      showCustomModal('Proszę wypełnić wszystkie pola dla przypomnienia.');
      return;
    }
    const newReminder = {
      id: Date.now(), // Unikalne ID
      text: newReminderText,
      date: newReminderDate,
      time: newReminderTime,
      completed: false,
    };
    setReminders([...reminders, newReminder]);
    setNewReminderText('');
    setNewReminderDate('');
    setNewReminderTime('');
    showCustomModal('Przypomnienie dodane!');
  };

  // Funkcja do usuwania przypomnienia
  const deleteReminder = (id) => {
    setReminders(reminders.filter(reminder => reminder.id !== id));
    showCustomModal('Przypomnienie usunięte.');
  };

  // Funkcja do dodawania nowego wydarzenia/randki
  const addEvent = () => {
    if (newEventTitle.trim() === '' || newEventDate === '' || newEventTime === '' || newEventLocation.trim() === '') {
      showCustomModal('Proszę wypełnić wszystkie pola dla wydarzenia.');
      return;
    }
    const newEvent = {
      id: Date.now(), // Unikalne ID
      title: newEventTitle,
      date: newEventDate,
      time: newEventTime,
      location: newEventLocation,
      isDate: isDateEvent, // Czy to randka
    };
    setEvents([...events, newEvent]);
    setNewEventTitle('');
    setNewEventDate('');
    setNewEventTime('');
    setNewEventLocation('');
    setIsDateEvent(false);
    showCustomModal('Wydarzenie dodane!');
  };

  // Funkcja do usuwania wydarzenia
  const deleteEvent = (id) => {
    setEvents(events.filter(event => event.id !== id));
    showCustomModal('Wydarzenie usunięte.');
  };

  // Funkcja do generowania pomysłów na randki za pomocą Google Search
  const generateDateIdeas = async () => {
    setLoadingDateIdeas(true);
    setDateIdeas([]); // Czyścimy poprzednie pomysły

    try {
      // Wywołanie narzędzia google_search
      // Tutaj symulujemy wywołanie narzędzia, w prawdziwej aplikacji byłby to fetch do backendu
      // który wywołałby google_search.search
      const prompt = "Pomysły na randki w Polsce"; // Można by dostosować prompt
      const chatHistory = [];
      chatHistory.push({ role: "user", parts: [{ text: prompt }] });
      const payload = { contents: chatHistory };
      const apiKey = ""; // Klucz API zostanie automatycznie dostarczony przez Canvas
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();

      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        // Parsowanie odpowiedzi (zakładamy, że to lista punktowana lub podobna)
        const ideas = text.split('\n').filter(line => line.trim() !== '');
        setDateIdeas(ideas);
      } else {
        showCustomModal('Nie udało się wygenerować pomysłów na randki. Spróbuj ponownie.');
      }
    } catch (error) {
      console.error("Błąd podczas generowania pomysłów na randki:", error);
      showCustomModal('Wystąpił błąd podczas generowania pomysłów na randki.');
    } finally {
      setLoadingDateIdeas(false);
    }
  };


  // Sortowanie wydarzeń i przypomnień według daty i czasu
  const sortedReminders = [...reminders].sort((a, b) => {
    const dateTimeA = new Date(`${a.date}T${a.time}`);
    const dateTimeB = new Date(`${b.date}T${b.time}`);
    return dateTimeA - dateTimeB;
  });

  const sortedEvents = [...events].sort((a, b) => {
    const dateTimeA = new Date(`${a.date}T${a.time}`);
    const dateTimeB = new Date(`${b.date}T${b.time}`);
    return dateTimeA - dateTimeB;
  });

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-100 to-purple-100 font-sans text-gray-800 p-4 sm:p-8 rounded-lg shadow-lg">
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
          body {
            font-family: 'Inter', sans-serif;
          }
        `}
      </style>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <p className="text-lg font-semibold mb-4">{modalMessage}</p>
            <button
              onClick={() => setShowModal(false)}
              className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105"
            >
              OK
            </button>
          </div>
        </div>
      )}

      <h1 className="text-4xl sm:text-5xl font-extrabold text-center text-blue-700 mb-8 drop-shadow-md">
        Twój Osobisty Asystent
      </h1>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Sekcja Przypomnienia */}
        <div className="bg-white p-6 rounded-xl shadow-lg border border-blue-200">
          <h2 className="text-2xl font-bold text-blue-600 mb-6 flex items-center">
            <Bell className="mr-3 text-blue-500" size={28} /> Przypomnienia
          </h2>
          <div className="mb-6 space-y-4">
            <input
              type="text"
              placeholder="Co masz do zapamiętania?"
              className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200"
              value={newReminderText}
              onChange={(e) => setNewReminderText(e.target.value)}
            />
            <div className="flex flex-col sm:flex-row gap-4">
              <input
                type="date"
                className="w-full sm:w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200"
                value={newReminderDate}
                onChange={(e) => setNewReminderDate(e.target.value)}
              />
              <input
                type="time"
                className="w-full sm:w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-200"
                value={newReminderTime}
                onChange={(e) => setNewReminderTime(e.target.value)}
              />
            </div>
            <button
              onClick={addReminder}
              className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full flex items-center justify-center transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
            >
              <Plus className="mr-2" size={20} /> Dodaj Przypomnienie
            </button>
          </div>

          <div>
            {sortedReminders.length === 0 ? (
              <p className="text-gray-500 text-center py-4">Brak przypomnień. Dodaj nowe!</p>
            ) : (
              <ul className="space-y-3">
                {sortedReminders.map((reminder) => (
                  <li
                    key={reminder.id}
                    className="flex items-center justify-between bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-100"
                  >
                    <div>
                      <p className="font-semibold text-blue-800">{reminder.text}</p>
                      <p className="text-sm text-gray-600">
                        {reminder.date} o {reminder.time}
                      </p>
                    </div>
                    <button
                      onClick={() => deleteReminder(reminder.id)}
                      className="text-red-500 hover:text-red-700 transition duration-200"
                      title="Usuń przypomnienie"
                    >
                      <Trash2 size={20} />
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>

        {/* Sekcja Wydarzenia i Randki */}
        <div className="bg-white p-6 rounded-xl shadow-lg border border-purple-200">
          <h2 className="text-2xl font-bold text-purple-600 mb-6 flex items-center">
            <Calendar className="mr-3 text-purple-500" size={28} /> Wydarzenia i Randki
          </h2>
          <div className="mb-6 space-y-4">
            <input
              type="text"
              placeholder="Tytuł wydarzenia/randki"
              className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition duration-200"
              value={newEventTitle}
              onChange={(e) => setNewEventTitle(e.target.value)}
            />
            <div className="flex flex-col sm:flex-row gap-4">
              <input
                type="date"
                className="w-full sm:w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition duration-200"
                value={newEventDate}
                onChange={(e) => setNewEventDate(e.target.value)}
              />
              <input
                type="time"
                className="w-full sm:w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition duration-200"
                value={newEventTime}
                onChange={(e) => setNewEventTime(e.target.value)}
              />
            </div>
            <input
              type="text"
              placeholder="Miejsce (np. Restauracja 'U Kucharza')"
              className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400 transition duration-200"
              value={newEventLocation}
              onChange={(e) => setNewEventLocation(e.target.value)}
            />
            <div className="flex items-center">
              <input
                type="checkbox"
                id="isDateEvent"
                className="mr-2 h-5 w-5 text-purple-600 rounded focus:ring-purple-500"
                checked={isDateEvent}
                onChange={(e) => setIsDateEvent(e.target.checked)}
              />
              <label htmlFor="isDateEvent" className="text-gray-700 font-medium">
                To jest randka
              </label>
            </div>
            <button
              onClick={addEvent}
              className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-full flex items-center justify-center transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
            >
              <Plus className="mr-2" size={20} /> Dodaj Wydarzenie
            </button>
          </div>

          <div>
            {sortedEvents.length === 0 ? (
              <p className="text-gray-500 text-center py-4">Brak zaplanowanych wydarzeń.</p>
            ) : (
              <ul className="space-y-3">
                {sortedEvents.map((event) => (
                  <li
                    key={event.id}
                    className={`flex items-center justify-between p-4 rounded-lg shadow-sm border ${
                      event.isDate ? 'bg-pink-50 border-pink-100' : 'bg-purple-50 border-purple-100'
                    }`}
                  >
                    <div>
                      <p className="font-semibold text-purple-800 flex items-center">
                        {event.isDate && <Heart className="mr-2 text-pink-500" size={18} />}
                        {event.title}
                      </p>
                      <p className="text-sm text-gray-600">
                        {event.date} o {event.time} w {event.location}
                      </p>
                    </div>
                    <button
                      onClick={() => deleteEvent(event.id)}
                      className="text-red-500 hover:text-red-700 transition duration-200"
                      title="Usuń wydarzenie"
                    >
                      <Trash2 size={20} />
                    </button>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>
      </div>

      {/* Sekcja Pomysły na Randki */}
      <div className="mt-8 bg-white p-6 rounded-xl shadow-lg border border-green-200">
        <h2 className="text-2xl font-bold text-green-600 mb-6 flex items-center">
          <Lightbulb className="mr-3 text-green-500" size={28} /> Pomysły na Randki
        </h2>
        <button
          onClick={generateDateIdeas}
          className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full flex items-center justify-center transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
          disabled={loadingDateIdeas}
        >
          {loadingDateIdeas ? (
            <>
              <span className="animate-spin mr-2">⚙️</span> Generowanie...
            </>
          ) : (
            <>
              <Heart className="mr-2" size={20} /> Generuj Pomysły na Randki
            </>
          )}
        </button>

        {dateIdeas.length > 0 && (
          <div className="mt-6">
            <h3 className="text-xl font-semibold text-gray-700 mb-3">Oto kilka pomysłów:</h3>
            <ul className="list-disc list-inside space-y-2 text-gray-700 bg-green-50 p-4 rounded-lg border border-green-100">
              {dateIdeas.map((idea, index) => (
                <li key={index}>{idea}</li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
